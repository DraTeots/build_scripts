# Makefile_hdutil

PWD = $(shell pwd)

ifdef HDUTIL_VERSION
 SOURCE_CODE_TARGET = $(HDUTIL_HOME)/.untar_done
 ifdef HDUTIL_DIRTAG
  HDUTIL_DIR = hdutil-$(HDUTIL_VERSION)^$(HDUTIL_DIRTAG)
 else
  HDUTIL_DIR = hdutil-$(HDUTIL_VERSION)
 endif
 TARFILE = $(HDUTIL_VERSION).tar.gz
else
 SOURCE_CODE_TARGET = $(HDUTIL_HOME)/.clone_done
 ifndef HDUTIL_URL
  HDUTIL_URL=https://github.com/jeffersonlab/hd_utilities
 endif
 ifdef HDUTIL_DIRTAG
  HDUTIL_DIR = $(notdir $(HDUTIL_URL))^$(HDUTIL_DIRTAG)
 else
  HDUTIL_DIR = $(notdir $(HDUTIL_URL))
 endif
 ifndef HDUTIL_BRANCH
  HDUTIL_BRANCH = master
 endif
endif

HDUTIL_HOME = $(PWD)/$(HDUTIL_DIR)

all: $(HDUTIL_HOME)/hdutil_prereqs_version.xml prod_link

$(TARFILE):
	wget --no-check-certificate -O $@ https://github.com/jeffersonlab/hd_utilities/archive/$(TARFILE)

$(HDUTIL_HOME)/.clone_done:
	git clone -b $(HDUTIL_BRANCH) $(HDUTIL_URL) $(HDUTIL_DIR)
ifdef HDUTIL_HASH
	cd $(HDUTIL_DIR) ; git checkout $(HDUTIL_HASH)
endif
	date > $@

$(HDUTIL_HOME)/.untar_done: $(TARFILE)
	rm -rf untar_temp_dir
	mkdir untar_temp_dir
	cd untar_temp_dir ; tar zxf ../$(TARFILE)
	mv -v untar_temp_dir/* $(HDUTIL_DIR)
	rmdir -v untar_temp_dir
	date > $@

$(HDUTIL_HOME)/hdutil_prereqs_version.xml: $(SOURCE_CODE_TARGET)
	cd $(HDUTIL_HOME) ; $(BUILD_SCRIPTS)/version_prereqs.pl hdutil

prod_link: $(HDUTIL_HOME)/hdutil_prereqs_version.xml
	test -L prod || ln -s $(HDUTIL_DIR) prod # will not overwrite existing link
