WHICH_GFORTRAN = $(shell which gfortran)
PWD = $(shell pwd)
HALLD_SRC = src
# for example VERSION_LABEL = release-2009-04-27
ifdef $(VERSION_LABEL)
HALLD_DIR = $(VERSION_LABEL)
REPOSITORY_LOCATION = tags/$(HALLD_DIR)
else
HALLD_DIR = latest
REPOSITORY_LOCATION = trunk/src
endif
export HALLD_HOME = $(PWD)/$(HALLD_DIR)
export HALLD_MY = $(HALLD_HOME)
CD_COMMAND = cd $(HALLD_HOME)

all: env prod_link

env:
	@echo WHICH_GFORTRAN = $(WHICH_GFORTRAN)

prod_link: make_halld
	test -L prod || ln -s $(HALLD_DIR) prod # will not overwrite existing link

make_halld: $(HALLD_HOME)/.getarg_patches_done
	$(MAKE) -C$(HALLD_HOME)/src

$(HALLD_HOME)/.getarg_patches_done: $(HALLD_HOME)/.checkout_done
ifneq (,$(findstring gfortran,$(WHICH_GFORTRAN)))
	cp -pv $(BUILD_SCRIPTS)/patches/getarg_fix/* \
		$(HALLD_HOME)/src/programs/Simulation/HDGeant
endif
	date > $@

$(HALLD_HOME)/.checkout_done: $(HALLD_HOME)/.halld_home_made
	$(CD_COMMAND); svn co https://halldsvn.jlab.org/repos/$(REPOSITORY_LOCATION)
	# following statements necessary to prevent remake of event.xml!
	#touch $(HALLD_HOME)/src/libraries/HDDM/hddm_s.h
	#touch $(HALLD_HOME)/src/libraries/HDDM/hddm_s.c
	date > $@

$(HALLD_HOME)/.halld_home_made:
	test -d $(HALLD_HOME) || mkdir -p $(HALLD_HOME)
	date > $@
