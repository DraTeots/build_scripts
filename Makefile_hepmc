PWD = $(shell pwd)

SOURCE_CODE_TARGET = $(HEPMC_HOME)/.untar_done
ifdef HEPMC_DIRTAG
 HEPMC_DIR = hepmc-$(HEPMC_VERSION)^$(HEPMC_DIRTAG)
else
 HEPMC_DIR = hepmc-$(HEPMC_VERSION)
endif
TARFILE = Hepmc-$(HEPMC_VERSION).tar.gz

HEPMC_HOME = $(PWD)/$(HEPMC_DIR)

all: $(HEPMC_HOME)/hepmc_prereqs.xml

$(TARFILE):
	wget --no-verbose --no-check-certificate -O $@ https://hepmc.hepforge.org/downloads?f=$(TARFILE)

$(HEPMC_HOME)/.untar_done: $(TARFILE)
	rm -rf untar_temp_dir
	mkdir untar_temp_dir
	cd untar_temp_dir ; tar zxf ../$(TARFILE)
	mv -v untar_temp_dir/Hepmc/R$(subst .,-,$(HEPMC_VERSION)) $(HEPMC_DIR)
	rm -rv untar_temp_dir
	date > $@

$(HEPMC_HOME)/.cmake_done: $(SOURCE_CODE_TARGET)
	cd $(HEPMC_HOME) ; mkdir -p build
	cd $(HEPMC_HOME)/build; $(CMAKE) -DCMAKE_INSTALL_PREFIX=../ \
	   -DHEPMC_PHOTOS=ON -DHEPMC2_ROOT_DIR=$HEPMC_HOME \
	   -DPHOTOSPP_ROOT_DIR=$PHOTOS_HOME ..
	date > $@

$(HEPMC_HOME)/.make_done: $(HEPMC_HOME)/.cmake_done
	make -C $(HEPMC_HOME)/build
	date > $@

$(HEPMC_HOME)/.install_done: $(HEPMC_HOME)/.make_done
	make -C $(HEPMC_HOME)/build install
	date > $@

$(HEPMC_HOME)/hepmc_prereqs.xml: $(HEPMC_HOME)/.install_done
	cd $(HEPMC_HOME) ; $(BUILD_SCRIPTS)/version_prereqs.pl hepmc
