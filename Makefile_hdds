# Makefile_hdds

# Builds HDDS under a new directory rooted in the current working
# directory. The new directory (DIR_NAME) has a name that depends on
# the version being built.

# HDDS_VERSION defines which tagged version to build. It should
# correspond to the name of the desired directory in the repos/tags
# directory of the repository. If left undefined, the latest version
# will be checked out from the repos/trunk.

PWD = $(shell pwd)

ifndef HDDS_VERSION
SVN_URL = https://halldsvn.jlab.org/repos/trunk/hdds
DIR_NAME = hdds
else
TARFILE = hdds-$(HDDS_VERSION)-src.tar.gz
DIR_NAME = hdds-$(HDDS_VERSION)
endif
HDDS_HOME = $(PWD)/$(DIR_NAME)

all: prod_link

$(TARFILE):
	wget --no-check-certificate http://halldweb1.jlab.org/dist/$(TARFILE)

$(HDDS_HOME)/.untar_done: $(TARFILE)
	tar zxvf $(TARFILE)
	date > $@

$(HDDS_HOME)/.checkout_done:
	svn co $(SVN_URL)
	date > $@

ifdef HDDS_VERSION
sconstruct: $(HDDS_HOME)/.untar_done # tar file
else
sconstruct: $(HDDS_HOME)/.checkout_done # checkout
endif
	cd $(HDDS_HOME) ; scons install SHOWBUILD=1

$(HDDS_HOME)/hdds_prereqs_version.xml: sconstruct
	cd $(HDDS_HOME) ; $(BUILD_SCRIPTS)/version_prereqs.pl hdds

prod_link: $(HDDS_HOME)/hdds_prereqs_version.xml
	test -L prod || ln -s hdds prod # will not overwrite existing link
